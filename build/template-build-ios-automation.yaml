steps:
- task: AzureKeyVault@1
  displayName: 'Azure Key Vault: BuildAutomation'
  inputs:
    azureSubscription: '.NET Keyvault'
    KeyVaultName: buildautomation
    SecretsFilter: AppCenterDotNetiOSTestCertPassword

- task: DownloadSecureFile@1
  displayName: 'Download Certificate'
  inputs:
    secureFile: AppCenteriOSBuildCert.p12

- task: DownloadSecureFile@1
  displayName: 'Download Provisioning Provile'
  inputs:
    secureFile: 'TestFile.mobileprovision'

- task: UseDotNet@2
  inputs:
    version: 3.0.100
  displayName: 'Use .Net Core SDK 3.0.100'

- task: InstallAppleCertificate@2
  inputs:
    certSecureFile: 'AppCenteriOSBuildCert.p12'
    certPwd: '$(CertPW)'

- task: InstallAppleProvisioningProfile@1
  inputs:
    provProfileSecureFile: 'TestFile.mobileprovision'

- bash: |
    SYMLINK="6_4_0"
    # Set Xamarin.Android 10.0
    sudo $AGENT_HOMEDIRECTORY/scripts/select-xamarin-sdk.sh $SYMLINK
    # Set Mono 6.4.0
    echo "##vso[task.setvariable variable=PATH;]/Library/Frameworks/Mono.framework/Versions/$SYMLINK/bin:$PATH"
  displayName: Select Xamarin and Mono Version

- task: XamariniOS@2
  inputs:
    solutionFile: tests/devapps/XForms/XForms.iOS/XForms.iOS.csproj
    configuration: 'Debug'
    packageApp: true
    runNugetRestore: true
    args: '/p:APPCENTER_BUILD=1 /p:RunCodeAnalysis=false'
    signingIdentity: 'APPLE_CERTIFICATE_SIGNING_IDENTITY'
    signingProvisioningProfileID: 'APPLE_PROV_PROFILE_UUID'

- task: CopyFiles@2
  displayName: 'Copy ipa to staging directory'
  inputs:
    SourceFolder: tests/devapps/XForms/XForms.iOS/bin/iPhone/Debug
    Contents: '**/*.ipa'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    CleanTargetFolder: true
    OverWrite: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: Xamarin.iOS'
  inputs:
    ArtifactName: Xamarin.iOS
